<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stalcraft Price Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { user-select: none; outline: none; }
        
        /* Глобальные улучшения скролла */
        * {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        html {
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
            overscroll-behavior: none;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #252525, #1e1e1e);
            color: #eee;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 14px;
            overscroll-behavior: none;
        }
        .app-container {
            background-color: #333;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0;
            overflow: hidden;
        }
        .app-header { 
            padding: 10px 15px;
            text-align: center; 
            background-color: #333;
            z-index: 2;
            position: sticky;
            top: 0;
        }
        .app-nav {
            background-color: #444;
            padding: 8px 15px;
            border-radius: 8px;
            margin: 0 15px 15px 15px;
            overflow-x: auto;
            scrollbar-width: none;
            position: sticky;
            top: 58px;
            z-index: 1;
        }
        .app-nav::-webkit-scrollbar { display: none; }
        .app-nav ul { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: flex; 
            align-items: center; 
        }
        .app-nav li { margin-right: 10px; }
        .app-nav a {
            color: #ccc;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .app-nav a.active { background-color: #555; color: white; }
        .app-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
            -webkit-overflow-scrolling: touch;
            /* Улучшаем скролл для контента */
            scroll-behavior: smooth;
            scroll-padding: 10px;
            overscroll-behavior: contain;
        }
        .app-content::-webkit-scrollbar { width: 6px; }
        .app-content::-webkit-scrollbar-thumb { 
            background: #555; 
            border-radius: 3px; 
            /* Улучшаем видимость скроллбара */
            min-height: 40px;
        }
        .app-content::-webkit-scrollbar-track { background: #333; }
        .app-section {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .app-section.active {
            display: block;
            opacity: 1;
            animation: fade-slide-in 0.4s ease-out;
        }
        .app-footer {
            border-top: 1px solid #eaeaea;
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.8em;
        }
        .filter-options label, .filter-options select, .filter-options input, button, .key-input {
            margin-bottom: 15px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #444;
            color: #ddd;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        button:hover {
            background-color: #555;
            color: white;
            border-color: #666;
            cursor: pointer;
        }
        .tracked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #555;
            background-color: #383838;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tracked-item.profitable { background-color: rgba(39, 174, 96, 0.7); }
        .tracked-item.unprofitable { background-color: rgba(192, 57, 43, 0.7); }
        .tracked-item:hover { background-color: #444; }
        .tracked-item-name { 
            flex-grow: 1; 
            margin-right: 10px; 
            font-weight: 500;
        }
        .tracked-item-price {
            font-weight: bold;
            margin-right: 10px;
        }
        .untrack-btn {
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 5px 8px; 
            border-radius: 4px; 
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .untrack-btn:hover {
            background: #c0392b;
        }
        #search-item {
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px;
            border: 1px solid #555;
            border-radius: 20px;
            background-color: #444;
            color: #eee;
            outline: none;
            margin-bottom: 15px;
        }
         .search-container {
             position: relative;
             margin-bottom: 15px;
         }
        .item-details {
            width: 100%;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
            display: none;
            box-sizing: border-box;
            margin-top: 10px;
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
            -webkit-overflow-scrolling: touch;
            /* Применяем улучшенный скролл ко всем скроллируемым контейнерам */
            scroll-behavior: smooth;
            scroll-padding: 5px;
            overscroll-behavior: contain;
        }
        .item-details .item {
            display: block;
            padding: 15px;
            color: #eee;
            border-bottom: 1px solid #555;
            background-color: #383838;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .item-details .item:hover { background-color: #444; }
        .item-details .item:last-child { border-bottom: none; }
        .item-details .item h3 { 
            margin: 0 0 5px 0; 
            font-size: 1em;
        }
        .item-details .price-input { 
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
            margin-top: 8px;
            gap: 8px;
        }
        .item-details button.track-button, .item-details button.details-button {
            background-color: #007bff;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
            width: 100%;
            text-align: center;
            margin-right: 0;
        }
        .item-details button.details-button {
            background-color: #2ecc71;
        }
        .item-details button.track-button:hover { background-color: #0056b3; }
        .item-details button.details-button:hover { background-color: #27ae60; }
        .filter-toggle {
            background-color: #444;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .filter-toggle:hover { background-color: #555; }
        .filter-toggle svg { transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .filter-toggle.active svg { transform: rotate(90deg); }
        .filter-options {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            margin-bottom: 15px;
            opacity: 0;
            transform: translateY(-10px);
        }
        .filter-options.open { max-height: 200px; opacity: 1; transform: translateY(0); }
        .filter-options input[type="number"] {
            width: calc(50% - 5px);
            display: inline-block;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            margin-bottom: 10px;
        }
        .filter-options input[type="number"]:nth-child(odd) { margin-right: 10px; }
        .filter-options input[type="number"]::-webkit-inner-spin-button,
        .filter-options input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .filter-options select { 
            width: 100%; 
            box-sizing: border-box; 
            margin-bottom: 10px;
        }
        #key-duration { -webkit-appearance: none; -moz-appearance: textfield; }
        #key-duration::-webkit-inner-spin-button,
        #key-duration::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #generated-key {
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            word-break: break-all;
        }
        #generated-key:hover { background-color: #555; }
        .notification {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            padding: 12px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            text-align: center;
        }
        .notification.show {
            opacity: 1;
            animation: slide-up 0.3s ease-in-out;
        }
        @keyframes slide-up {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .admin-block {
            background-color: #383838;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .admin-block h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #fff;
        }
        .user-list {
            max-height: 150px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #555 #383838;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scroll-padding: 5px;
            overscroll-behavior: contain;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #555;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .user-item:hover { background-color: #404040; }
        .user-item:last-child { border-bottom: none; }
        .user-info { flex-grow: 1; margin-right: 5px; }
        .user-info span { display: block; }
        .user-info .plan { color: #bbb; font-size: 0.85em; }
        .disable-btn {
            background-color: #c0392b;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: auto;
        }
        .disable-btn:hover { background-color: #a93226; }
        .broadcast-form {
            position: relative;
        }
        .broadcast-form textarea {
            width: 100%;
            height: 70px;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 6px;
            color: #ddd;
            padding: 10px;
            margin-bottom: 10px;
            resize: none;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .broadcast-image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: none;
        }
        .broadcast-image-container {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }
        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }
        .image-upload-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .image-upload-btn {
            background-color: #555;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .image-upload-btn:hover {
            background-color: #666;
        }
        .image-upload-btn svg {
            width: 16px;
            height: 16px;
        }
        .broadcast-status {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
            display: none;
        }
        .pricing-editor {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .pricing-editor label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            margin-bottom: 0;
        }
        .pricing-editor input[type="number"] {
            width: 60px;
            padding: 5px;
            margin-bottom: 0;
            box-sizing: border-box;
        }
        .pricing-editor button {
             width: auto;
             padding: 5px 10px;
             margin-left: auto;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .settings-grid label {
            font-size: 0.9em;
            margin-bottom: 5px;
             display: block;
        }
        .settings-grid input[type="number"],
        .settings-grid select {
            width: 100%;
            padding: 8px;
            margin-bottom: 0;
            box-sizing: border-box;
        }
        .pricing-table img, .pricing-table svg {
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }
        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .pricing-table th, .pricing-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
        }
        .pricing-table th {
            background-color: #444;
        }
        .pricing-table td:first-child {
            text-align: left;
        }
        @media (max-width: 400px) {
            .app-container {
                width: 100%;
                border-radius: 0;
                 min-height: 100vh;
            }
             .app-header, .app-nav, .app-footer {
                 position: static;
             }
            .filter-options input[type="number"] {
                width: 100%;
                margin-right: 0;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .pricing-editor {
                 flex-direction: column;
                 align-items: stretch;
             }
             .pricing-editor button {
                 margin-left: 0;
                 margin-top: 10px;
             }
            .notification {
                bottom: 10px;
                width: 90%;
            }
        }
        @keyframes fade-slide-in {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        #admin input[type="number"] {
            -moz-appearance: textfield;
        }
        #admin input[type="number"]::-webkit-inner-spin-button,
        #admin input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #admin .pricing-editor input[type="number"] {
            background-color: #444;
            color: #ddd;
            border: 1px solid #555;
            border-radius: 6px;
            width: 60px;
            padding: 5px;
            margin-bottom: 0;
            font-size: 0.9em; 
        }
        #admin .settings-grid input[type="number"] {
            background-color: #444;
            color: #ddd;
            border: 1px solid #555;
            border-radius: 6px;
            width: 100%;
            padding: 8px;
            margin-bottom: 0;
            font-size: 0.9em; 
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background-color: #333;
            border-radius: 8px;
            margin: 20px auto;
            width: 90%;
            max-width: 400px;
            position: relative;
            padding-bottom: 15px;
        }
        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            color: #fff;
            background: #444;
            border: none;
            border-radius: 20px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .item-image {
            width: 100%;
            height: 200px;
            background-color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .item-image img {
            max-width: 50%;
            max-height: 80%;
        }
        .modal-tabs {
            display: flex;
            justify-content: space-around;
            margin: 0 15px 15px;
            border-bottom: 1px solid #555;
        }
        .modal-tab {
            padding: 10px 5px;
            color: #ccc;
            cursor: pointer;
            text-align: center;
            flex-grow: 1;
            font-size: 0.9em;
        }
        .modal-tab.active {
            color: #fff;
            border-bottom: 2px solid #007bff;
        }
        .modal-panel {
            display: none;
            padding: 0 15px;
        }
        .modal-panel.active {
            display: block;
        }
        .buy-sell-tabs {
            display: flex;
            margin: 0 0 15px;
            border: 1px solid #555;
            border-radius: 6px;
            overflow: hidden;
        }
        .buy-sell-tab {
            padding: 10px;
            color: #fff;
            cursor: pointer;
            text-align: center;
            flex-grow: 1;
            background-color: #333;
        }
        .buy-sell-tab.active {
            background-color: #555;
        }
        .price-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-right: 10px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .price-label {
            color: #fff;
            font-size: 0.9em;
        }
        .price-value {
            color: #2196F3;
            text-decoration: underline;
            cursor: pointer;
            margin-left: auto;
        }
        .price-info {
            margin: 10px 0;
            color: #ccc;
            font-size: 0.85em;
        }
        .price-input {
            width: 100%;
            padding: 10px;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .emoji {
            margin-right: 5px;
        }
        .form-row {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .sales-table-container {
            width: 100%;
            overflow-x: auto;
            background-color: #212121;
            border-radius: 6px;
        }
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .sales-table th, .sales-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #333;
        }
        .sales-table th {
            text-align: center;
            font-weight: normal;
            color: #aaa;
        }
        .sales-table td {
            text-align: center;
        }
        .sales-table tr:last-child td {
            border-bottom: none;
        }
        .compensation-container {
            padding: 10px 0;
        }
        .compensation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .compensation-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .compensation-controls input {
            width: 70px;
            padding: 8px;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 6px;
            color: #ddd;
            -moz-appearance: textfield;
        }
        .compensation-controls input::-webkit-inner-spin-button,
        .compensation-controls input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .compensation-info {
            margin: 10px 0;
            padding: 8px;
            background-color: #444;
            border-radius: 6px;
            color: #ddd;
            text-align: center;
        }
        .compensation-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .compensation-actions button {
            background-color: #3498db;
            width: auto;
            padding: 8px 15px;
        }
        .compensation-actions button:hover {
            background-color: #2980b9;
        }
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .confirmation-content {
            background-color: #333;
            padding: 25px;
            border-radius: 8px;
            width: 85%;
            max-width: 350px;
            text-align: center;
        }
        .confirmation-message {
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .confirmation-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .confirmation-actions button {
            width: auto;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .confirm-yes {
            background-color: #f44336;
            color: white;
        }
        .confirm-yes:hover {
            background-color: #d32f2f;
        }
        .confirm-no {
            background-color: #9e9e9e;
            color: white;
        }
        .confirm-no:hover {
            background-color: #757575;
        }

        /* Добавляем эти стили в конец CSS для улучшения скролла */
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth;
            scroll-padding: 5px;
            overscroll-behavior: contain;
        }

        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 3px;
            min-height: 40px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
        }

        /* Применяем класс scroll-container ко всем скроллируемым элементам */
        .app-content,
        .app-nav,
        .user-list,
        .item-details,
        .modal-panel,
        .sales-table-container {
            scrollbar-width: thin;
            scrollbar-color: #555 #333;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Stalcraft Price Tracker</h1>
        </header>
        <nav class="app-nav">
            <ul>
                <li><a href="#profile" class="active">Кабинет</a></li>
                <li><a href="#instructions">Инструкция</a></li>
                <li><a href="#filtering">Предметы</a></li>
                <li><a href="#tracking">Отслеживаемое</a></li>
                <li><a href="#pricing">Тарифы</a></li>
                <li><a href="#keygen">Создание ключей</a></li>
                <li><a href="#activation">Активация ключей</a></li>
                <li><a href="#admin">Админ-панель</a></li>
            </ul>
        </nav>
        <main class="app-content scroll-container" id="app-content">
            <section id="profile" class="app-section active">
                <h2>Кабинет</h2>
                <p>Уровень подписки: <span class="subscription-info">Нет</span></p>
                <p>Действует до: <span class="subscription-info">Нет</span></p>
                <p>Слоты: <span class="subscription-info">44/100</span></p>
                <button id="contact-support">Поддержка</button>
            </section>
            <section id="instructions" class="app-section">
                <h2>Инструкция</h2>
                <p>Здесь будет текст инструкции...</p>
            </section>
            <section id="filtering" class="app-section">
                <h2>Предметы</h2>
                <button class="filter-toggle">
                    <span class="filter-text">Фильтры</span> 
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 4L6 8L10 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="filter-options">
                    <input type="number" id="min-price" placeholder="Мин. цена">
                    <input type="number" id="max-price" placeholder="Макс. цена">
                    <input type="number" id="discount" placeholder="Скидка (%)">
                    <select id="category">
                        <option value="">Все категории</option>
                        <option value="weapons">Оружие</option>
                        <option value="armor">Броня и снаряжение</option>
                        <option value="artifacts">Артефакты</option>
                        <option value="ammo">Амуниция и боеприпасы</option>
                        <option value="meds">Медикаменты</option>
                        <option value="food">Еда и напитки</option>
                        <option value="components">Компоненты и материалы</option>
                        <option value="quest">Квестовые предметы</option>
                    </select>
                </div>
                 <div class="search-container">
                     <input type="text" id="search-item" placeholder="Поиск предмета">
                    <div class="item-details scroll-container"></div>
                 </div>
            </section>
            <section id="tracking" class="app-section">
                <h2>Отслеживаемое</h2>
                <div id="tracked-items-container"></div>
            </section>
            <section id="pricing" class="app-section">
                <h2>Тарифы</h2>
                <table class="pricing-table">
                    <thead>
                        <tr>
                            <th>Опция</th>
                            <th>Обычный</th>
                            <th>Продвинутый</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Цена</td><td id="display-price-normal">500 руб</td><td id="display-price-advanced">1000 руб</td></tr>
                        <tr><td>Задержка отправки</td><td>3-5 секунд</td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/><path d="M6 6L18 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/></svg></td></tr>
                        <tr><td>Доступ на 24 часа</td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/><path d="M6 6L18 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/></svg></td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12L10 17L19 8" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></td></tr>
                        <tr><td>Копирование названия</td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/><path d="M6 6L18 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/></svg></td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12L10 17L19 8" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></td></tr>
                        <tr><td>Расширенная статистика</td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/><path d="M6 6L18 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/></svg></td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12L10 17L19 8" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></td></tr>
                        <tr><td>Статистика по стакам</td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/><path d="M6 6L18 18" stroke="#ff5252" stroke-width="2" stroke-linecap="round"/></svg></td><td><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12L10 17L19 8" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></td></tr>
                    </tbody>
                </table>
            </section>
            <section id="keygen" class="app-section">
                <h2>Создание ключей</h2>
                <select id="key-type" class="key-input" style="margin-bottom: 15px;">
                    <option value="Обычная">Обычная подписка</option>
                    <option value="Продвинутая">Продвинутая подписка</option>
                </select>
                <input type="number" id="key-duration" class="key-input" placeholder="Срок действия (дни)">
                <button id="generate-key">Сгенерировать ключ</button>
                <p id="generated-key"></p>
            </section>
            <section id="activation" class="app-section">
                <h2>Активация ключей</h2>
                <input type="text" id="activation-key" class="key-input" placeholder="Введите ключ (xxxxx-xxxxx-xxxxx)">
                <button id="activate-key">Активировать</button>
            </section>
            <section id="admin" class="app-section">
                <h2>Админ-панель</h2>
                <div class="admin-block">
                    <h3>Пользователи (<span id="user-count">3</span>)</h3>
                    <div class="user-list scroll-container" id="user-list-container">
                        </div>
                </div>
                <div class="admin-block">
                    <h3>Рассылка</h3>
                    <form class="broadcast-form" id="broadcast-form">
                        <div class="broadcast-image-container" id="image-preview-container">
                            <img src="" alt="Preview" class="broadcast-image-preview" id="broadcast-image-preview">
                            <button type="button" class="remove-image-btn" id="remove-image-btn">✕</button>
                        </div>
                        <textarea placeholder="Введите сообщение для рассылки" id="broadcast-message"></textarea>
                        <div class="image-upload-container">
                            <label class="image-upload-btn" for="image-upload">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 16L8.586 11.414C8.96106 11.0391 9.46967 10.8284 10 10.8284C10.5303 10.8284 11.0389 11.0391 11.414 11.414L16 16M14 14L15.586 12.414C15.9611 12.0391 16.4697 11.8284 17 11.8284C17.5303 11.8284 18.0389 12.0391 18.414 12.414L20 14M14 8H14.01M6 20H18C18.5304 20 19.0391 19.7893 19.4142 19.4142C19.7893 19.0391 20 18.5304 20 18V6C20 5.46957 19.7893 4.96086 19.4142 4.58579C19.0391 4.21071 18.5304 4 18 4H6C5.46957 4 4.96086 4.21071 4.58579 4.58579C4.21071 4.96086 4 5.46957 4 6V18C4 18.5304 4.21071 19.0391 4.58579 19.4142C4.96086 19.7893 5.46957 20 6 20Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Добавить изображение
                            </label>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;">
                        </div>
                        <div class="broadcast-status" id="broadcast-status"></div>
                        <button type="submit">Отправить</button>
                    </form>
                </div>
                <div class="admin-block">
                    <h3>Редактирование тарифов</h3>
                    <div class="pricing-editor" id="pricing-editor-form">
                        <label>Обычный: <input type="number" id="price-normal" value="500"> руб</label>
                        <label>Продвинутый: <input type="number" id="price-advanced" value="1000"> руб</label>
                        <button type="button" id="save-prices">Сохранить</button>
                    </div>
                </div>
                <div class="admin-block">
                    <h3>Настройка тарифов</h3>
                    <div class="settings-grid" id="tariff-settings-form">
                        <label>Слоты (Обычный)<input type="number" id="slots-normal" value="100"></label>
                        <label>Слоты (Продв.)<input type="number" id="slots-advanced" value="200"></label>
                        <label>Задержка (сек)<input type="number" id="delay-setting" value="3"></label>
                    </div>
                    <button style="margin-top: 10px" id="apply-settings">Применить</button>
                </div>
                
                <div class="admin-block">
                    <h3>Массовое изменение срока подписки</h3>
                    <div class="compensation-container">
                        <div class="compensation-controls">
                            <label>
                                <span>Дней:</span>
                                <input type="number" id="compensation-days" value="1" min="-365" max="365">
                            </label>
                            <label>
                                <span>Часов:</span>
                                <input type="number" id="compensation-hours" value="0" min="-24" max="24">
                            </label>
                        </div>
                        <div class="compensation-info" id="compensation-message">
                            Добавить всем активным пользователям 1 день
                        </div>
                        <div class="compensation-actions">
                            <button id="compensation-button">Изменить срок</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="app-footer">Подвал</footer>
        <div class="notification" id="notification"></div>
    </div>
    <div class="modal" id="item-detail-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-modal">×</button>
            <h2 style="text-align: center; margin: 15px 15px; padding-top: 20px;">Продвинутые запчасти</h2>
            
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="overview">Главная</div>
                <div class="modal-tab" data-tab="history">Последние 10 продаж</div>
                <div class="modal-tab" data-tab="analytics">Диапазон</div>
                <div class="modal-tab" data-tab="specs">Стаки</div>
            </div>
            
            <div class="modal-panel active scroll-container" id="panel-overview">
                <div class="price-option">
                    <label class="switch">
                        <input type="checkbox" id="filter-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="price-label">Фильтр включен</span>
                </div>
                
                <div class="buy-sell-tabs">
                    <div class="buy-sell-tab active" data-trade="buy">Хочу купить</div>
                    <div class="buy-sell-tab" data-trade="sell">Хочу продать</div>
                </div>
                
                <div id="buy-panel">
                    <div class="price-option">
                        <span class="emoji">💰</span>
                        <span class="price-label">Уведомлять, когда цена будет ниже</span>
                    </div>
                    
                    <div class="price-option">
                        <span class="emoji">⏰</span>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="price-label">Уведомлять, когда будет истекать срок</span>
                    </div>
                    
                    <div class="price-option">
                        <span class="emoji">🔊</span>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="price-label">Звуковое уведомление</span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">Цена для покупки</div>
                        <input type="number" class="price-input" placeholder="0">
                    </div>
                </div>
                
                <div id="sell-panel" style="display: none;">
                    <div class="price-option">
                        <span class="emoji">📈</span>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="price-label">Уведомлять, когда цена станет выше</span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <div style="font-size: 0.9em; margin-bottom: 5px;">Цена для продажи</div>
                        <input type="number" class="price-input" placeholder="0">
                    </div>
                </div>
            </div>
            
            <div class="modal-panel scroll-container" id="panel-history">
                <h3 style="margin-top: 5px; margin-bottom: 15px;">Последние 10 продаж (МСК)</h3>
                <div class="sales-table-container scroll-container">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Дата продажи</th>
                                <th>Кол-во</th>
                                <th>Цена</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>13.04.2025 15:16</td>
                                <td>8</td>
                                <td>640 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:15</td>
                                <td>1</td>
                                <td>75 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:14</td>
                                <td>1</td>
                                <td>75 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:13</td>
                                <td>1</td>
                                <td>75 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:12</td>
                                <td>10</td>
                                <td>798 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:11</td>
                                <td>1</td>
                                <td>77 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:10</td>
                                <td>1</td>
                                <td>77 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:09</td>
                                <td>11</td>
                                <td>820 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:08</td>
                                <td>1</td>
                                <td>75 000 ₽</td>
                            </tr>
                            <tr>
                                <td>13.04.2025 15:07</td>
                                <td>10</td>
                                <td>778 000 ₽</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-panel scroll-container" id="panel-analytics">
                <h3 style="margin-top: 5px; margin-bottom: 15px;">Диапазон цен</h3>
                <div class="sales-table-container scroll-container">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Диапазон цен</th>
                                <th>Продажи</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>69 500 — 72 600</td>
                                <td>371</td>
                            </tr>
                            <tr>
                                <td>72 600 — 75 700</td>
                                <td>1886</td>
                            </tr>
                            <tr>
                                <td>75 700 — 78 800</td>
                                <td>2984</td>
                            </tr>
                            <tr>
                                <td>78 800 — 81 900</td>
                                <td>1225</td>
                            </tr>
                            <tr>
                                <td>81 900 — 85 000</td>
                                <td>190</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-panel scroll-container" id="panel-specs">
                <h3 style="margin-top: 5px; margin-bottom: 15px;">Размер стака</h3>
                <div class="sales-table-container scroll-container">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Размер стака</th>
                                <th>Продажи</th>
                                <th>Средняя цена</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>9536</td>
                                <td>77234</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>177</td>
                                <td>78266</td>
                            </tr>
                            <tr>
                                <td>10</td>
                                <td>885</td>
                                <td>82123</td>
                            </tr>
                            <tr>
                                <td>25</td>
                                <td>10</td>
                                <td>80096</td>
                            </tr>
                            <tr>
                                <td>50</td>
                                <td>48</td>
                                <td>86734</td>
                            </tr>
                            <tr>
                                <td>100</td>
                                <td>120</td>
                                <td>87058</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="confirmation-modal" id="confirmation-modal" style="display: none;">
        <div class="confirmation-content">
            <div class="confirmation-message"></div>
            <div class="confirmation-actions">
                <button class="confirm-yes">Подтвердить</button>
                <button class="confirm-no">Отмена</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Fix for touch events in Telegram WebApp
            document.querySelectorAll('button, .modal-tab, .buy-sell-tab, .tracked-item, .app-nav a').forEach(element => {
                element.addEventListener('touchstart', function(e) {
                    // Prevent default touch behavior
                    e.preventDefault();
                    // Trigger click event
                    this.click();
                }, { passive: false });
            });
            
            const navLinks = document.querySelectorAll('.app-nav a');
            const sections = document.querySelectorAll('.app-section');
            const appContent = document.getElementById('app-content');
            const searchInput = document.getElementById('search-item');
            const itemDetails = document.querySelector('#filtering .item-details');
            const trackedItemsContainer = document.getElementById('tracked-items-container');
            const minPriceInput = document.getElementById('min-price');
            const maxPriceInput = document.getElementById('max-price');
            const discountInput = document.getElementById('discount');
            const categorySelect = document.getElementById('category');
            
            // Declare filterItems function early so it can be accessed by other functions
            function filterItems() {
                const searchTerm = searchInput.value.toLowerCase();
                
                if (!searchTerm) {
                    itemDetails.style.display = "none";
                    return;
                }
                
                // Filter items based on search term, category, price and discount
                let filteredItems = items.filter(item => {
                    // Filter by search term
                    if (!item.name.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                    
                    // Filter by category if selected
                    const selectedCategory = categorySelect.value;
                    if (selectedCategory && item.category !== selectedCategory) {
                        return false;
                    }
                    
                    // Filter by min price if provided
                    const minPrice = parseInt(minPriceInput.value);
                    if (!isNaN(minPrice) && item.price < minPrice) {
                        return false;
                    }
                    
                    // Filter by max price if provided
                    const maxPrice = parseInt(maxPriceInput.value);
                    if (!isNaN(maxPrice) && item.price > maxPrice) {
                        return false;
                    }
                    
                    // Filter by discount if provided
                    const minDiscount = parseInt(discountInput.value);
                    if (!isNaN(minDiscount) && item.discount < minDiscount) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Update tracked status for each filtered item
                const trackedIds = new Set(trackedItems);
                filteredItems.forEach(item => {
                    item.tracked = trackedIds.has(item.id);
                });
                
                // Limit results to top 10 for performance
                filteredItems = filteredItems.slice(0, 10);
                
                if (filteredItems.length > 0) {
                    renderItemSuggestions(filteredItems);
                } else {
                    itemDetails.style.display = "none";
                }
            }
            
            // Полностью заменяем функцию enableDragToScroll на оптимизированную версию
            function enableDragToScroll(element) {
                // Мы используем только базовые события скролла для комфортной работы на всех устройствах
                // Вместо перехвата событий и реализации кастомного скролла
                
                // Проверяем, доступен ли SmoothScroll API
                if ('scrollBehavior' in document.documentElement.style) {
                    // Современные браузеры поддерживают плавный скролл через CSS
                    element.style.scrollBehavior = 'smooth';
                }
                
                // Добавляем поддержку инерции скролла для iOS
                element.style.webkitOverflowScrolling = 'touch';
                
                // Предотвращаем растягивание страницы при достижении границы скролла
                element.style.overscrollBehavior = 'contain';
            }
            
            // Apply optimized scroll to scrollable containers
            document.querySelectorAll('.scroll-container').forEach(container => {
                enableDragToScroll(container);
            });
            
            const filterToggle = document.querySelector('.filter-toggle');
            const filterOptions = document.querySelector('.filter-options');
            const filterToggleText = filterToggle.querySelector('.filter-text');
            const generateKeyBtn = document.getElementById('generate-key');
            const keyDurationInput = document.getElementById('key-duration');
            const generatedKeyDisplay = document.getElementById('generated-key');
            const activateKeyBtn = document.getElementById('activate-key');
            const activationKeyInput = document.getElementById('activation-key');
            const notification = document.getElementById('notification');
            const contactSupportBtn = document.getElementById('contact-support');
            const userListContainer = document.getElementById('user-list-container');
            const userCountSpan = document.getElementById('user-count');
            const broadcastForm = document.getElementById('broadcast-form');
            const broadcastMessageInput = document.getElementById('broadcast-message');
            const broadcastStatus = document.getElementById('broadcast-status');
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('broadcast-image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const removeImageBtn = document.getElementById('remove-image-btn');
            const savePricesBtn = document.getElementById('save-prices');
            const applySettingsBtn = document.getElementById('apply-settings');
            const priceNormalInput = document.getElementById('price-normal');
            const priceAdvancedInput = document.getElementById('price-advanced');
            const slotsNormalInput = document.getElementById('slots-normal');
            const slotsAdvancedInput = document.getElementById('slots-advanced');
            const delaySettingInput = document.getElementById('delay-setting');

            let subscriptionData = {
                level: "Нет",
                expirationDate: null,
                slots: { used: 44, total: 100 },
                generatedKeys: {}
            };
            
            let items = [
                // Оружие
                { id: "aks_74", name: "АКС-74", category: "weapons", price: 85000, discount: 0, tracked: false, desiredPrice: 85000 },
                { id: "ak_74", name: "АК-74", category: "weapons", price: 75000, discount: 0, tracked: false, desiredPrice: 75000 },
                { id: "ak_74m", name: "АК-74М", category: "weapons", price: 95000, discount: 0, tracked: false, desiredPrice: 95000 },
                { id: "abakan", name: "Абакан", category: "weapons", price: 120000, discount: 0, tracked: false, desiredPrice: 120000 },
                { id: "val", name: "ВАЛ", category: "weapons", price: 150000, discount: 0, tracked: false, desiredPrice: 150000 },
                { id: "vintorez", name: "Винторез", category: "weapons", price: 160000, discount: 0, tracked: false, desiredPrice: 160000 },
                { id: "f2000", name: "F2000", category: "weapons", price: 200000, discount: 0, tracked: false, desiredPrice: 200000 },
                { id: "lr_300", name: "ЛР-300", category: "weapons", price: 110000, discount: 0, tracked: false, desiredPrice: 110000 },
                { id: "pm", name: "ПМ", category: "weapons", price: 30000, discount: 0, tracked: false, desiredPrice: 30000 },
                { id: "fora_12", name: "Фора-12", category: "weapons", price: 70000, discount: 0, tracked: false, desiredPrice: 70000 },
                { id: "toz_34", name: "ТОЗ-34", category: "weapons", price: 65000, discount: 0, tracked: false, desiredPrice: 65000 },
                { id: "obrez", name: "Обрез", category: "weapons", price: 45000, discount: 0, tracked: false, desiredPrice: 45000 },
                { id: "mp_133", name: "МП-133", category: "weapons", price: 75000, discount: 0, tracked: false, desiredPrice: 75000 },
                { id: "saiga_12", name: "Сайга-12", category: "weapons", price: 95000, discount: 0, tracked: false, desiredPrice: 95000 },
                { id: "spsa_14", name: "СПСА-14", category: "weapons", price: 115000, discount: 0, tracked: false, desiredPrice: 115000 },
                { id: "svd", name: "СВД", category: "weapons", price: 180000, discount: 0, tracked: false, desiredPrice: 180000 },
                { id: "rpk", name: "РПК", category: "weapons", price: 170000, discount: 0, tracked: false, desiredPrice: 170000 },
                { id: "pkm", name: "ПКМ", category: "weapons", price: 200000, discount: 0, tracked: false, desiredPrice: 200000 },
                { id: "groza", name: "Гроза", category: "weapons", price: 130000, discount: 0, tracked: false, desiredPrice: 130000 },
                { id: "f_1", name: "Ф-1", category: "weapons", price: 25000, discount: 0, tracked: false, desiredPrice: 25000 },
                { id: "rgd_5", name: "РГД-5", category: "weapons", price: 20000, discount: 0, tracked: false, desiredPrice: 20000 },
                { id: "gm_94", name: "ГМ-94", category: "weapons", price: 160000, discount: 0, tracked: false, desiredPrice: 160000 },
                { id: "rpg_7", name: "РПГ-7", category: "weapons", price: 250000, discount: 0, tracked: false, desiredPrice: 250000 },
                
                // Броня и снаряжение
                { id: "modular_armor", name: "Модульная броня", category: "armor", price: 150000, discount: 0, tracked: false, desiredPrice: 150000 },
                { id: "zarya", name: "Заря", category: "armor", price: 90000, discount: 0, tracked: false, desiredPrice: 90000 },
                { id: "berill", name: "Берилл", category: "armor", price: 120000, discount: 0, tracked: false, desiredPrice: 120000 },
                { id: "kora_25", name: "КОРА-25", category: "armor", price: 110000, discount: 0, tracked: false, desiredPrice: 110000 },
                { id: "kora_42", name: "КОРА-42", category: "armor", price: 130000, discount: 0, tracked: false, desiredPrice: 130000 },
                { id: "seva", name: "СЕВА", category: "armor", price: 160000, discount: 0, tracked: false, desiredPrice: 160000 },
                { id: "kpk", name: "КПК", category: "armor", price: 40000, discount: 0, tracked: false, desiredPrice: 40000 },
                { id: "detector", name: "Детектор", category: "armor", price: 50000, discount: 0, tracked: false, desiredPrice: 50000 },
                { id: "binoculars", name: "Бинокль", category: "armor", price: 30000, discount: 0, tracked: false, desiredPrice: 30000 },
                { id: "knife", name: "Нож", category: "armor", price: 15000, discount: 0, tracked: false, desiredPrice: 15000 },
                { id: "gas_mask", name: "Противогаз", category: "armor", price: 35000, discount: 0, tracked: false, desiredPrice: 35000 },
                { id: "respirator", name: "Респиратор", category: "armor", price: 25000, discount: 0, tracked: false, desiredPrice: 25000 },
                { id: "backpack", name: "Рюкзак", category: "armor", price: 45000, discount: 0, tracked: false, desiredPrice: 45000 },
                { id: "balaclava", name: "Балаклава", category: "armor", price: 10000, discount: 0, tracked: false, desiredPrice: 10000 },
                { id: "helmet", name: "Шлем", category: "armor", price: 50000, discount: 0, tracked: false, desiredPrice: 50000 },
                { id: "bodyarmor", name: "Бронежилет", category: "armor", price: 80000, discount: 0, tracked: false, desiredPrice: 80000 },
                
                // Артефакты
                { id: "medusa", name: "Артефакт \"Медуза\"", category: "artifacts", price: 80000, discount: 0, tracked: false, desiredPrice: 80000 },
                { id: "flash", name: "Артефакт \"Вспышка\"", category: "artifacts", price: 90000, discount: 0, tracked: false, desiredPrice: 90000 },
                { id: "eye", name: "Артефакт \"Глаз\"", category: "artifacts", price: 100000, discount: 0, tracked: false, desiredPrice: 100000 },
                { id: "dummy", name: "Артефакт \"Пустышка\"", category: "artifacts", price: 50000, discount: 0, tracked: false, desiredPrice: 50000 },
                { id: "gravi", name: "Артефакт \"Грави\"", category: "artifacts", price: 120000, discount: 0, tracked: false, desiredPrice: 120000 },
                { id: "goldfish", name: "Артефакт \"Золотая рыбка\"", category: "artifacts", price: 150000, discount: 0, tracked: false, desiredPrice: 150000 },
                { id: "soul", name: "Артефакт \"Душа\"", category: "artifacts", price: 200000, discount: 0, tracked: false, desiredPrice: 200000 },
                { id: "battery", name: "Артефакт \"Батарейка\"", category: "artifacts", price: 80000, discount: 0, tracked: false, desiredPrice: 80000 },
                { id: "crystal", name: "Артефакт \"Кристалл\"", category: "artifacts", price: 110000, discount: 0, tracked: false, desiredPrice: 110000 },
                { id: "moms_beads", name: "Артефакт \"Мамины бусы\"", category: "artifacts", price: 250000, discount: 0, tracked: false, desiredPrice: 250000 },
                { id: "fireball", name: "Артефакт \"Огненный шар\"", category: "artifacts", price: 130000, discount: 0, tracked: false, desiredPrice: 130000 },
                
                // Амуниция и боеприпасы
                { id: "ammo_545x39", name: "Патроны 5.45x39", category: "ammo", price: 15000, discount: 0, tracked: false, desiredPrice: 15000 },
                { id: "ammo_556x45", name: "Патроны 5.56x45", category: "ammo", price: 18000, discount: 0, tracked: false, desiredPrice: 18000 },
                { id: "ammo_762x39", name: "Патроны 7.62x39", category: "ammo", price: 20000, discount: 0, tracked: false, desiredPrice: 20000 },
                { id: "ammo_762x54", name: "Патроны 7.62x54", category: "ammo", price: 25000, discount: 0, tracked: false, desiredPrice: 25000 },
                { id: "ammo_9x18", name: "Патроны 9x18", category: "ammo", price: 8000, discount: 0, tracked: false, desiredPrice: 8000 },
                { id: "ammo_9x19", name: "Патроны 9x19", category: "ammo", price: 10000, discount: 0, tracked: false, desiredPrice: 10000 },
                { id: "ammo_9x39", name: "Патроны 9x39", category: "ammo", price: 22000, discount: 0, tracked: false, desiredPrice: 22000 },
                { id: "ammo_12x70", name: "Патроны 12x70", category: "ammo", price: 12000, discount: 0, tracked: false, desiredPrice: 12000 },
                
                // Медикаменты
                { id: "medkit", name: "Аптечка", category: "meds", price: 10000, discount: 0, tracked: false, desiredPrice: 10000 },
                { id: "bandage", name: "Бинт", category: "meds", price: 5000, discount: 0, tracked: false, desiredPrice: 5000 },
                { id: "antirad", name: "Антирад", category: "meds", price: 8000, discount: 0, tracked: false, desiredPrice: 8000 },
                { id: "anabiotic", name: "Анабиотик", category: "meds", price: 15000, discount: 0, tracked: false, desiredPrice: 15000 },
                { id: "stimulator", name: "Стимулятор", category: "meds", price: 12000, discount: 0, tracked: false, desiredPrice: 12000 },
                { id: "energy_drink", name: "Энергетик", category: "meds", price: 6000, discount: 0, tracked: false, desiredPrice: 6000 },
                
                // Еда и напитки
                { id: "canned_food", name: "Консервы", category: "food", price: 4000, discount: 0, tracked: false, desiredPrice: 4000 },
                { id: "sausage", name: "Колбаса", category: "food", price: 3000, discount: 0, tracked: false, desiredPrice: 3000 },
                { id: "bread", name: "Хлеб", category: "food", price: 2000, discount: 0, tracked: false, desiredPrice: 2000 },
                { id: "mre", name: "Сухпаек", category: "food", price: 7000, discount: 0, tracked: false, desiredPrice: 7000 },
                { id: "vodka", name: "Водка", category: "food", price: 5000, discount: 0, tracked: false, desiredPrice: 5000 },
                { id: "water", name: "Вода", category: "food", price: 3500, discount: 0, tracked: false, desiredPrice: 3500 },
                
                // Компоненты и материалы
                { id: "adv_parts", name: "Продвинутые запчасти", category: "components", price: 78000, discount: 0, tracked: false, desiredPrice: 78000 },
                { id: "bolt", name: "Болт", category: "components", price: 1000, discount: 0, tracked: false, desiredPrice: 1000 },
                { id: "nut", name: "Гайка", category: "components", price: 1000, discount: 0, tracked: false, desiredPrice: 1000 },
                { id: "battery_item", name: "Батарейка", category: "components", price: 3000, discount: 0, tracked: false, desiredPrice: 3000 },
                { id: "tape", name: "Изолента", category: "components", price: 2500, discount: 0, tracked: false, desiredPrice: 2500 },
                { id: "wire", name: "Проволока", category: "components", price: 2000, discount: 0, tracked: false, desiredPrice: 2000 },
                { id: "fabric", name: "Материя", category: "components", price: 3500, discount: 0, tracked: false, desiredPrice: 3500 },
                { id: "leather", name: "Кожа", category: "components", price: 4500, discount: 0, tracked: false, desiredPrice: 4500 },
                { id: "spring", name: "Пружина", category: "components", price: 2800, discount: 0, tracked: false, desiredPrice: 2800 },
                { id: "chip", name: "Микросхема", category: "components", price: 6000, discount: 0, tracked: false, desiredPrice: 6000 },
                { id: "guitar", name: "Гитара", category: "components", price: 9000, discount: 0, tracked: false, desiredPrice: 9000 },
                { id: "weapon_parts", name: "Детали оружия", category: "components", price: 12000, discount: 0, tracked: false, desiredPrice: 12000 },
                { id: "optics", name: "Оптика", category: "components", price: 15000, discount: 0, tracked: false, desiredPrice: 15000 },
                { id: "gun_oil", name: "Оружейная смазка", category: "components", price: 5000, discount: 0, tracked: false, desiredPrice: 5000 },
                { id: "tools", name: "Инструменты", category: "components", price: 8000, discount: 0, tracked: false, desiredPrice: 8000 },
                { id: "glue", name: "Клей", category: "components", price: 3000, discount: 0, tracked: false, desiredPrice: 3000 },
                
                // Квестовые предметы
                { id: "flash_drive", name: "Флешка", category: "quest", price: 30000, discount: 0, tracked: false, desiredPrice: 30000 },
                { id: "documents", name: "Документы", category: "quest", price: 25000, discount: 0, tracked: false, desiredPrice: 25000 },
                { id: "key", name: "Ключ", category: "quest", price: 20000, discount: 0, tracked: false, desiredPrice: 20000 },
                { id: "access_card", name: "Карта доступа", category: "quest", price: 35000, discount: 0, tracked: false, desiredPrice: 35000 },
                { id: "pda", name: "ПДА", category: "quest", price: 40000, discount: 0, tracked: false, desiredPrice: 40000 }
            ];

            let trackedItems = [];

            let adminData = {
                users: [
                    { id: '001', name: 'User1', plan: 'Продвинутая', expires: '2025-05-01', enabled: true },
                    { id: '002', name: 'User2', plan: 'Обычная', expires: '2025-04-15', enabled: true },
                    { id: '003', name: 'User3', plan: 'Продвинутая', expires: '2025-06-01', enabled: true },
                ],
                prices: { normal: 500, advanced: 1000 },
                settings: { slotsNormal: 100, slotsAdvanced: 200, delay: 3 }
            };

            function updatePricingTableDisplay() {
                const normalPriceCell = document.getElementById('display-price-normal');
                const advancedPriceCell = document.getElementById('display-price-advanced');
                if (normalPriceCell && advancedPriceCell) {
                    normalPriceCell.textContent = `${adminData.prices.normal} руб`;
                    advancedPriceCell.textContent = `${adminData.prices.advanced} руб`;
                }
            }

            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.style.backgroundColor = type === 'error' ? '#c0392b' : '#27ae60';
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            function updateSubscriptionDisplay() {
                const subscriptionInfoElements = document.querySelectorAll('#profile .subscription-info');
                if (subscriptionInfoElements.length >= 3) {
                    subscriptionInfoElements[0].textContent = subscriptionData.level;
                    
                    // Display expiration date or "Нет" if no subscription
                    if (subscriptionData.expirationDate) {
                        const formattedDate = subscriptionData.expirationDate.toISOString().split('T')[0];
                        subscriptionInfoElements[1].textContent = formattedDate;
                    } else {
                        subscriptionInfoElements[1].textContent = "Нет";
                    }
                    
                    subscriptionInfoElements[2].textContent = `${subscriptionData.slots.used}/${subscriptionData.slots.total}`;
                }
            }

            function setActiveSection(hash) {
                navLinks.forEach(l => l.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));

                const targetLink = document.querySelector(`.app-nav a[href="${hash}"]`);
                const targetSection = document.querySelector(hash);

                if (targetLink && targetSection) {
                    targetLink.classList.add('active');
                    targetSection.classList.add('active');
                    appContent.scrollTop = 0;
                } else {
                    document.querySelector('.app-nav a[href="#profile"]').classList.add('active');
                    document.querySelector('#profile').classList.add('active');
                }
            }

            setActiveSection(window.location.hash || '#profile'); 

            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetHash = link.getAttribute('href');
                    setActiveSection(targetHash);
                    window.location.hash = targetHash;
                });
            });

            window.addEventListener('hashchange', () => {
                setActiveSection(window.location.hash);
            });

            filterToggle.addEventListener('click', () => {
                filterOptions.classList.toggle('open');
                filterToggle.classList.toggle('active');
                filterToggleText.textContent = filterOptions.classList.contains('open') ? 'Скрыть фильтры' : 'Фильтры';
            });
           
            function renderItemSuggestions(filteredItems) {
                itemDetails.innerHTML = "";
                if (filteredItems.length > 0) {
                    itemDetails.style.display = "block";
                    filteredItems.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.classList.add('item');
                        itemElement.dataset.itemId = item.id;
                        itemElement.innerHTML = `
                            <h3>${item.name}</h3>
                            <div class="price-input">
                                <button class="track-button">${item.tracked ? 'Отслеживается' : 'Отслеживать'}</button>
                                <button class="details-button">Подробнее</button>
                            </div>
                        `;
                        itemDetails.appendChild(itemElement);
                        
                        const trackButton = itemElement.querySelector('.track-button');
                        const detailsButton = itemElement.querySelector('.details-button');

                        if (item.tracked) {
                            trackButton.disabled = true;
                        }

                        trackButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            trackItem(item.id, item.price);
                            filterItems();
                            renderTrackedItems();
                        });
                        
                        detailsButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showItemDetails(item);
                            const modal = document.getElementById('item-detail-modal');
                            modal.style.display = 'block';
                        });
                         
                        itemElement.addEventListener('click', () => {
                            showItemDetails(item);
                        });
                    });
                } else {
                    itemDetails.style.display = "none";
                }
            }

            [searchInput, minPriceInput, maxPriceInput, discountInput, categorySelect].forEach(input => {
                input.addEventListener('input', filterItems);
            });

            document.addEventListener('click', (e) => {
                // Проверяем, был ли клик вне поля поиска и вне результатов поиска,
                // но только если не было взаимодействия с модальным окном
                const modal = document.getElementById('item-detail-modal');
                const isModalVisible = modal.style.display === 'block';
                
                if (!itemDetails.contains(e.target) && 
                    e.target !== searchInput && 
                    !isModalVisible && 
                    !modal.contains(e.target)) {
                    itemDetails.style.display = 'none';
                }
            });
            
            searchInput.addEventListener('blur', () => {
                // Удаляем автоматическое скрытие результатов поиска
                // setTimeout(() => {
                //     if (!itemDetails.matches(':hover')) {
                //         itemDetails.style.display = 'none';
                //     }
                // }, 150);
            });
            
            searchInput.addEventListener('keydown', e => { 
                if (e.key === 'Enter') {
                    searchInput.blur(); 
                    // Убираем автоматическое скрытие результатов поиска
                    // itemDetails.style.display = 'none'; 
                }
            });

            function trackItem(itemId, desiredPrice) {
                if (trackedItems.length >= subscriptionData.slots.total) {
                    showNotification('Достигнут лимит слотов отслеживания', 'error');
                    return;
                }
                if (!trackedItems.includes(itemId)) {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        item.desiredPrice = desiredPrice;
                        trackedItems.push(itemId);
                        subscriptionData.slots.used = trackedItems.length;
                        updateSubscriptionDisplay();
                        showNotification(`Предмет "${item.name}" добавлен в отслеживаемое`);
                        
                        // Navigate to tracking section
                        setActiveSection('#tracking');
                        window.location.hash = '#tracking';
                    }
                } else {
                    showNotification('Предмет уже отслеживается', 'error');
                }
            }

            function untrackItem(itemId) {
                const index = trackedItems.indexOf(itemId);
                if (index > -1) {
                    const item = items.find(i => i.id === itemId);
                    trackedItems.splice(index, 1);
                    subscriptionData.slots.used = trackedItems.length;
                    updateSubscriptionDisplay();
                    renderTrackedItems();
                    filterItems();
                    if (item) {
                        showNotification(`Предмет "${item.name}" удален из отслеживаемого`);
                    }
                }
            }

            function renderTrackedItems() {
                trackedItemsContainer.innerHTML = '';
                if (trackedItems.length === 0) {
                    trackedItemsContainer.innerHTML = '<p>Нет отслеживаемых предметов.</p>';
                    return;
                }
                
                trackedItems.forEach(itemId => {
                    const item = items.find(i => i.id === itemId);
                    if (item) {
                        const isProfitable = item.price <= item.desiredPrice; 
                        const trackedItemElement = document.createElement('div');
                        trackedItemElement.classList.add('tracked-item', isProfitable ? 'profitable' : 'unprofitable');
                        trackedItemElement.innerHTML = `
                            <span class="tracked-item-name">${item.name}</span>
                            <span class="tracked-item-price">${item.price} руб</span>
                            <button class="untrack-btn" data-item-id="${item.id}">✕</button>
                        `;
                        trackedItemsContainer.appendChild(trackedItemElement);

                        trackedItemElement.querySelector('.untrack-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            untrackItem(item.id);
                        });
                         
                        trackedItemElement.addEventListener('click', () => {
                            navigator.clipboard.writeText(item.name)
                                .then(() => showNotification(`Название "${item.name}" скопировано`))
                                .catch(() => showNotification('Не удалось скопировать', 'error'));
                        });
                    }
                });
            }

            function generateKeyString() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let key = '';
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 5; j++) {
                        key += characters.charAt(Math.floor(Math.random() * characters.length));
                    }
                    if (i < 2) key += '-';
                }
                return key;
            }

            generateKeyBtn.addEventListener('click', () => {
                const duration = parseInt(keyDurationInput.value);
                const keyType = document.getElementById('key-type').value;
                
                if (!duration || duration <= 0) {
                    showNotification('Введите корректный срок действия (в днях)', 'error');
                    return;
                }
                const key = generateKeyString();
                
                // Store both duration and subscription type
                subscriptionData.generatedKeys[key] = {
                    duration: duration,
                    type: keyType
                };
                
                generatedKeyDisplay.textContent = key;
                generatedKeyDisplay.style.display = 'block';
                showNotification(`Ключ "${keyType}" подписки на ${duration} дней сгенерирован`);
                keyDurationInput.value = '';
            });

            generatedKeyDisplay.addEventListener('click', () => {
                const key = generatedKeyDisplay.textContent;
                if (key) {
                    navigator.clipboard.writeText(key)
                        .then(() => showNotification('Ключ скопирован'))
                        .catch(() => showNotification('Не удалось скопировать ключ', 'error'));
                }
            });

            activateKeyBtn.addEventListener('click', () => {
                const key = activationKeyInput.value.trim().toUpperCase();
                if (!/^[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}$/.test(key)) {
                    showNotification('Неверный формат ключа (должен быть XXXXX-XXXXX-XXXXX)', 'error');
                    return;
                }

                let keyDuration = 30;
                let keySubscriptionType = "Обычная";
                let keyFound = false;

                if (subscriptionData.generatedKeys[key]) {
                    keyDuration = subscriptionData.generatedKeys[key].duration;
                    keySubscriptionType = subscriptionData.generatedKeys[key].type;
                    delete subscriptionData.generatedKeys[key];
                    keyFound = true;
                } else {
                    // For testing, allow any valid format key
                    keyFound = true;
                    
                    // Determine subscription type by key's first character
                    if (key.charAt(0) === 'A') {
                        keySubscriptionType = "Продвинутая";
                        // Increase slot limit for advanced subscription
                        subscriptionData.slots.total = 200;
                    }
                    
                    // Simulate different durations based on key
                    keyDuration = (parseInt(key.charAt(1)) || 3) * 7; // Use second character to determine days (×7)
                }

                if (keyFound) {
                    // Set subscription level based on key type
                    subscriptionData.level = keySubscriptionType;
                    
                    // Calculate new expiration date
                    const currentDate = new Date();
                    const expirationDate = new Date(currentDate);
                    expirationDate.setDate(expirationDate.getDate() + keyDuration);
                    subscriptionData.expirationDate = expirationDate;
                    
                    updateSubscriptionDisplay();
                    showNotification(`Ключ успешно активирован! Подписка "${keySubscriptionType}" на ${keyDuration} дней.`);
                    activationKeyInput.value = '';
                } else {
                    showNotification('Ключ не найден или уже использован', 'error');
                }
            });
            
            function renderAdminUsers() {
                userListContainer.innerHTML = '';
                userCountSpan.textContent = adminData.users.length;
                adminData.users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.innerHTML = `
                        <div class="user-info">
                            <span>${user.name} (ID: ${user.id})</span>
                            <span class="plan">${user.expires} | ${user.plan}</span>
                        </div>
                        <button class="disable-btn" data-user-id="${user.id}" style="background-color: ${user.enabled ? '#c0392b' : '#27ae60'};">
                            ${user.enabled ? 'Отключить' : 'Включить'}
                        </button>
                    `;
                    userListContainer.appendChild(userItem);

                    userItem.querySelector('.disable-btn').addEventListener('click', (e) => {
                        const userId = e.target.dataset.userId;
                        toggleUserStatus(userId);
                    });
                });
            }

            function toggleUserStatus(userId) {
                const user = adminData.users.find(u => u.id === userId);
                if (user) {
                    user.enabled = !user.enabled;
                    console.log(`Simulating ${user.enabled ? 'enabling' : 'disabling'} user ${userId}`);
                    renderAdminUsers();
                    showNotification(`Статус пользователя ${user.name} изменен`);
                }
            }

            // Telegram bot configuration
            const telegramBotToken = ''; // This would be filled with your actual bot token
            const telegramChatId = ''; // This would be filled with your chat ID
            
            let broadcastImage = null;
            
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        imagePreviewContainer.style.display = 'inline-block';
                        broadcastImage = file;
                    }
                    
                    reader.readAsDataURL(file);
                }
            });
            
            removeImageBtn.addEventListener('click', function() {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                imagePreviewContainer.style.display = 'none';
                imageUpload.value = '';
                broadcastImage = null;
            });

            broadcastForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = broadcastMessageInput.value.trim();
                
                if (!message && !broadcastImage) {
                    showNotification('Введите сообщение или добавьте изображение для рассылки', 'error');
                    return;
                }
                
                // Update status
                broadcastStatus.textContent = 'Отправка рассылки...';
                broadcastStatus.style.display = 'block';
                
                try {
                    // If there's an actual bot token, this would send the message
                    if (telegramBotToken && telegramChatId) {
                        // First send the image if there is one
                        if (broadcastImage) {
                            const formData = new FormData();
                            formData.append('chat_id', telegramChatId);
                            formData.append('photo', broadcastImage);
                            if (message) {
                                formData.append('caption', message);
                            }
                            
                            // This would be the actual API call if the token was valid
                            // await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                            //     method: 'POST',
                            //     body: formData
                            // });
                        } else if (message) {
                            // Just send the text message
                            const formData = new FormData();
                            formData.append('chat_id', telegramChatId);
                            formData.append('text', message);
                            
                            // This would be the actual API call if the token was valid
                            // await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
                            //     method: 'POST',
                            //     body: formData
                            // });
                        }
                    }
                    
                    // Simulate the API call delay
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    broadcastStatus.textContent = 'Рассылка успешно отправлена!';
                    setTimeout(() => {
                        broadcastStatus.style.display = 'none';
                    }, 3000);
                    
                    showNotification('Рассылка отправлена');
                    broadcastMessageInput.value = '';
                    imagePreview.src = '';
                    imagePreview.style.display = 'none';
                    imagePreviewContainer.style.display = 'none';
                    imageUpload.value = '';
                    broadcastImage = null;
                } catch (error) {
                    console.error('Error sending broadcast:', error);
                    broadcastStatus.textContent = 'Ошибка при отправке рассылки';
                    showNotification('Ошибка при отправке рассылки', 'error');
                }
            });

            savePricesBtn.addEventListener('click', () => {
                const normalPrice = parseInt(priceNormalInput.value);
                const advancedPrice = parseInt(priceAdvancedInput.value);
                if (!isNaN(normalPrice) && !isNaN(advancedPrice) && normalPrice >= 0 && advancedPrice >= 0) {
                    adminData.prices.normal = normalPrice;
                    adminData.prices.advanced = advancedPrice;
                    console.log("Simulating save prices:", adminData.prices);
                    updatePricingTableDisplay();
                    showNotification('Цены тарифов сохранены');
                } else {
                    showNotification('Введите корректные цены', 'error');
                }
            });

            applySettingsBtn.addEventListener('click', () => {
                const slotsNormal = parseInt(slotsNormalInput.value);
                const slotsAdvanced = parseInt(slotsAdvancedInput.value);
                const delay = parseInt(delaySettingInput.value);

                if (!isNaN(slotsNormal) && slotsNormal >= 0 &&
                    !isNaN(slotsAdvanced) && slotsAdvanced >= 0 &&
                    !isNaN(delay) && delay >= 0) {
                    
                    adminData.settings.slotsNormal = slotsNormal;
                    adminData.settings.slotsAdvanced = slotsAdvanced;
                    adminData.settings.delay = delay;
                    console.log("Simulating apply settings:", adminData.settings);
                    showNotification('Настройки тарифов применены');
                } else {
                    showNotification('Введите корректные числовые значения для слотов и задержки', 'error');
                }
            });

            // Handle compensation days/hours functionality
            const compensationDaysInput = document.getElementById('compensation-days');
            const compensationHoursInput = document.getElementById('compensation-hours');
            const compensationMessage = document.getElementById('compensation-message');
            const compensationButton = document.getElementById('compensation-button');
            
            function updateCompensationMessage() {
                const days = parseInt(compensationDaysInput.value) || 0;
                const hours = parseInt(compensationHoursInput.value) || 0;
                
                // Skip if both are zero
                if (days === 0 && hours === 0) {
                    compensationMessage.textContent = 'Укажите время для изменения срока подписки';
                    compensationButton.disabled = true;
                    return;
                }
                
                compensationButton.disabled = false;
                
                // Build message based on values
                let action = '';
                if ((days > 0 && hours >= 0) || (days === 0 && hours > 0)) {
                    action = 'Добавить';
                } else if ((days < 0 && hours <= 0) || (days === 0 && hours < 0)) {
                    action = 'Убрать';
                } else {
                    // Mixed case (e.g., -1 day, +2 hours)
                    compensationMessage.textContent = `Смешанное изменение: ${Math.abs(days)} дн. ${days > 0 ? 'добавить' : 'убрать'}, ${Math.abs(hours)} ч. ${hours > 0 ? 'добавить' : 'убрать'}`;
                    return;
                }
                
                let timeText = [];
                if (Math.abs(days) > 0) {
                    const daysText = getDayText(Math.abs(days));
                    timeText.push(`${Math.abs(days)} ${daysText}`);
                }
                
                if (Math.abs(hours) > 0) {
                    const hoursText = getHourText(Math.abs(hours));
                    timeText.push(`${Math.abs(hours)} ${hoursText}`);
                }
                
                compensationMessage.textContent = `${action} всем активным пользователям ${timeText.join(' и ')}`;
            }
            
            function getDayText(days) {
                if (days % 10 === 1 && days % 100 !== 11) {
                    return 'день';
                } else if ([2, 3, 4].includes(days % 10) && ![12, 13, 14].includes(days % 100)) {
                    return 'дня';
                } else {
                    return 'дней';
                }
            }
            
            function getHourText(hours) {
                if (hours % 10 === 1 && hours % 100 !== 11) {
                    return 'час';
                } else if ([2, 3, 4].includes(hours % 10) && ![12, 13, 14].includes(hours % 100)) {
                    return 'часа';
                } else {
                    return 'часов';
                }
            }
            
            function showConfirmationModal(message, onConfirm) {
                // Get existing modal
                const confirmationModal = document.getElementById('confirmation-modal');
                const messageElement = confirmationModal.querySelector('.confirmation-message');
                const yesButton = confirmationModal.querySelector('.confirm-yes');
                const noButton = confirmationModal.querySelector('.confirm-no');
                
                // Update message
                messageElement.textContent = message;
                
                // Setup event handlers (using once to auto-remove)
                noButton.onclick = () => {
                    confirmationModal.style.display = 'none';
                };
                
                yesButton.onclick = () => {
                    onConfirm();
                    confirmationModal.style.display = 'none';
                };
                
                // Show modal
                confirmationModal.style.display = 'flex';
            }
            
            compensationDaysInput.addEventListener('input', updateCompensationMessage);
            compensationHoursInput.addEventListener('input', updateCompensationMessage);
            
            compensationButton.addEventListener('click', () => {
                const days = parseInt(compensationDaysInput.value) || 0;
                const hours = parseInt(compensationHoursInput.value) || 0;
                
                if (days === 0 && hours === 0) {
                    return;
                }
                
                // Build message for confirmation
                const totalMilliseconds = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000);
                const action = totalMilliseconds > 0 ? 'добавить' : 'убрать';
                
                let timeText = [];
                if (Math.abs(days) > 0) {
                    const daysText = getDayText(Math.abs(days));
                    timeText.push(`${Math.abs(days)} ${daysText}`);
                }
                
                if (Math.abs(hours) > 0) {
                    const hoursText = getHourText(Math.abs(hours));
                    timeText.push(`${Math.abs(hours)} ${hoursText}`);
                }
                
                const confirmMessage = `Вы действительно хотите ${action} ${timeText.join(' и ')} всем активным пользователям?`;
                
                showConfirmationModal(confirmMessage, () => {
                    // Process compensation
                    adminData.users.forEach(user => {
                        if (user.enabled) {
                            // Parse current expiration date
                            const currentExpiry = new Date(user.expires);
                            
                            // Add or subtract time
                            currentExpiry.setTime(currentExpiry.getTime() + totalMilliseconds);
                            
                            // Update user
                            user.expires = currentExpiry.toISOString().split('T')[0];
                        }
                    });
                    
                    // Refresh display
                    renderAdminUsers();
                    
                    // Show notification
                    showNotification(`Время подписки изменено для всех активных пользователей!`);
                });
            });

            function loadAdminData() {
                priceNormalInput.value = adminData.prices.normal;
                priceAdvancedInput.value = adminData.prices.advanced;
                slotsNormalInput.value = adminData.settings.slotsNormal;
                slotsAdvancedInput.value = adminData.settings.slotsAdvanced;
                delaySettingInput.value = adminData.settings.delay;
                renderAdminUsers();
            }
             
            if (window.location.hash === '#admin') {
                loadAdminData();
            }
            
            const observer = new MutationObserver((mutationsList) => {
                for(let mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const adminSection = document.getElementById('admin');
                        if (adminSection.classList.contains('active')) {
                            loadAdminData();
                        }
                    }
                }
            });
            observer.observe(document.getElementById('admin'), { attributes: true });
             
            contactSupportBtn.addEventListener('click', () => {
                window.location.href = 'mailto:support@example.com?subject=Stalcraft Price Tracker Support'; 
                showNotification('Открытие почтового клиента...');
            });

            function showItemDetails(item) {
                // Update modal with item details
                const modal = document.getElementById('item-detail-modal');
                
                // Set title
                const modalTitle = modal.querySelector('h2');
                modalTitle.textContent = item.name;
                
                // Update sales timestamps with current Moscow time
                updateSalesTimestamps();
                
                // Show modal
                modal.style.display = 'block';
                
                // Prevent background scrolling when modal is open
                document.body.style.overflow = 'hidden';
            }
            
            // Function to update sales timestamps based on current Moscow time
            function updateSalesTimestamps() {
                // Get current date and time in Moscow timezone (UTC+3)
                const now = new Date();
                // Adjust to Moscow time (UTC+3)
                const mskTime = new Date(now.getTime() + (3 * 60 + now.getTimezoneOffset()) * 60000);
                
                // Get all timestamp cells in the sales table
                const salesTable = document.querySelector('#panel-history .sales-table tbody');
                if (!salesTable) return;
                
                const rows = salesTable.querySelectorAll('tr');
                
                // Update each row with decreasing timestamps (1 minute apart)
                rows.forEach((row, index) => {
                    const timeCell = row.querySelector('td:first-child');
                    if (timeCell) {
                        // Clone the current MSK time and subtract 'index' minutes
                        const saleTime = new Date(mskTime);
                        saleTime.setMinutes(mskTime.getMinutes() - index);
                        
                        // Format the date: DD.MM.YYYY HH:MM
                        const day = String(saleTime.getDate()).padStart(2, '0');
                        const month = String(saleTime.getMonth() + 1).padStart(2, '0');
                        const year = saleTime.getFullYear();
                        const hours = String(saleTime.getHours()).padStart(2, '0');
                        const minutes = String(saleTime.getMinutes()).padStart(2, '0');
                        
                        timeCell.textContent = `${day}.${month}.${year} ${hours}:${minutes}`;
                    }
                });
            }
            
            document.getElementById('close-modal').addEventListener('click', function() {
                const modal = document.getElementById('item-detail-modal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
                
                // Обеспечиваем, чтобы результаты поиска оставались видимыми после закрытия модального окна
                const searchInput = document.getElementById('search-item');
                if (searchInput.value.trim() !== '') {
                    const itemDetails = document.querySelector('#filtering .item-details');
                    if (itemDetails) {
                        itemDetails.style.display = 'block';
                    }
                }
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('item-detail-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    
                    // Обеспечиваем, чтобы результаты поиска оставались видимыми после закрытия модального окна
                    const searchInput = document.getElementById('search-item');
                    if (searchInput.value.trim() !== '') {
                        const itemDetails = document.querySelector('#filtering .item-details');
                        if (itemDetails) {
                            itemDetails.style.display = 'block';
                        }
                    }
                }
            });
            
            // Tab switching
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all panels
                    document.querySelectorAll('.modal-panel').forEach(p => p.classList.remove('active'));
                    // Show the selected panel
                    document.getElementById(`panel-${this.dataset.tab}`).classList.add('active');
                });
            });
            
            // Buy/Sell tab switching
            document.querySelectorAll('.buy-sell-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.buy-sell-tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show the relevant panel
                    if (this.dataset.trade === 'buy') {
                        document.getElementById('buy-panel').style.display = 'block';
                        document.getElementById('sell-panel').style.display = 'none';
                    } else {
                        document.getElementById('buy-panel').style.display = 'none';
                        document.getElementById('sell-panel').style.display = 'block';
                    }
                });
            });

            updateSubscriptionDisplay();
            renderTrackedItems(); 
            updatePricingTableDisplay();
        });
    </script>
</body>
</html>